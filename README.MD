# Geo Incident Service

Сервис для управления географическими инцидентами и мониторинга безопасности пользователей в реальном времени. Система позволяет операторам создавать зоны опасности (полигоны), а мобильным клиентам — проверять свое местонахождение на пересечение с этими зонами.

---

## Быстрый старт

### Запуск приложения через Docker
Самый простой способ запустить весь стек (App, DB, Redis, Webhook Stub):

```bash
# Клонирование и запуск
git clone <repository-url>
cd geo-incedent-service
docker-compose up -d --build
```

После запуска сервис будет доступен по адресу: http://localhost:8080

---

## Конфигурация

Настройка системы разделена на два уровня: базовые параметры через переменные окружения и детальная настройка через внутреннюю конфигурацию.

### Общие настройки (.env)
Основные параметры, необходимые для запуска и связи сервисов, задаются в файле `.env` в корне проекта.

HTTP_SERVER_PORT: Порт для запуска API сервера (например, 8080).
API_KEY: Ключ для доступа к защищенным методам API (передается в заголовок X-API-Key).
DATABASE_URL: Строка подключения к PostgreSQL (включая хост, порт, пользователя и имя БД).
REDIS_ADDR: Адрес подключения к Redis серверу.
WEBHOOK_URL: Базовый URL для отправки уведомлений о фиксации пользователя в опасной зоне.

### Тонкая настройка (./config)
Более детальные параметры приложения, такие как тайм-ауты, размеры пулов соединений и логика повторных попыток, определены в директории `./config`. Эти параметры позволяют адаптировать сервис под конкретные нагрузки и требования инфраструктуры.

Примеры настраиваемых параметров:
- Промежутки времени для сбора статистики (STATS_WINDOW_MINUTES).
- Тайм-ауты чтения/записи HTTP сервера.
- Настройки пула соединений PostgreSQL (MaxConns, MinConns, Timeouts).
- Параметры очередей Redis и политики Retry для вебхуков.

---

## База данных и Миграции

### SQL Миграции
Сервис использует библиотеку goose для управления схемой БД. Миграции выполняются автоматически при каждом запуске приложения.

Особенности схемы:
- Использование расширения PostGIS для работы с географическими данными.
- Таблица incidents: хранит полигоны опасных зон (тип geography).
- Таблица location_checks: логирует все проверки пользователей с привязкой к конкретному инциденту.

---

## Настройка Ngrok для Webhooks

### Ngrok Setup
Для тестирования отправки вебхуков на локальную машину через интернет:

1. Запустите ngrok для порта Webhook Stub (9090):
   ```bash
   ngrok http 9090
   ```
2. Скопируйте полученный URL (например, https://random.ngrok.io).
3. Обновите переменную WEBHOOK_URL в вашем .env:
   ```env
   WEBHOOK_URL=https://random.ngrok.io/webhook
   ```
4. Перезапустите контейнеры: `docker-compose up -d`

---

## Тест-кейсы (API Usage)

### Интерактивная документация
Swagger UI доступен по адресу: http://localhost:8080/swagger/index.html

### 1. Создание инцидента (POST)
Сценарий: Оператор создает зону опасности.
```bash
curl -X POST http://localhost:8080/api/v1/incidents \
  -H "X-API-Key: test-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Пожар в ТЦ",
    "description": "Эвакуация в радиусе 1км",
    "area": {
      "type": "Polygon",
      "coordinates": [[[37.6, 55.7], [37.7, 55.7], [37.7, 55.8], [37.6, 55.8], [37.6, 55.7]]]
    }
  }'
```

### 2. Проверка локации (POST - Public)
Сценарий: Пользователь находится внутри зоны инцидента.
```bash
curl -X POST http://localhost:8080/api/v1/location/check \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "8489c629-9e32-4d2d-9475-430349257bd7",
    "user_location": {
      "lat": 55.75,
      "lon": 37.65
    }
  }'
```
В ответе будет `is_danger: true`. Задача на отправку вебхука будет автоматически поставлена в очередь.

### 3. Получение статистики (GET)
Сценарий: Просмотр количества уникальных пользователей за установленный период.
```bash
curl -X GET http://localhost:8080/api/v1/incidents/stats \
  -H "X-API-Key: test-api-key"
```

### 4. Мониторинг здоровья (GET)
```bash
curl -X GET http://localhost:8080/api/v1/system/health \
  -H "X-API-Key: test-api-key"
```

---

## Тестирование приложения

### Запуск тестов
- Unit-тесты: `go test -v ./internal/service/...`
- Интеграционные тесты: `go test -v ./tests/...` (требуется запущенный docker-compose)

---

## Структура проекта
Проект реализован в соответствии с принципами Clean Architecture:
- /cmd — Точки входа в приложение.
- /internal/entity — Слой доменных сущностей.
- /internal/service — Слой бизнес-логики.
- /internal/repo — Слой работы с внешними хранилищами (PostgreSQL, Redis).
- /internal/delivery — HTTP транспортный слой (обработчики и роутинг).
- /internal/worker — Асинхронный обработчик фоновых задач.
